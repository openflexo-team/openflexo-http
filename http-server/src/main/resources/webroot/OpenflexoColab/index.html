<!DOCTYPE html>
<html>
<head>
	<title>Openflexo Colab</title>
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
	<link rel="stylesheet" href="/css/monaco-collab-ext.css">
	<link rel="stylesheet" href="/css/example.css">
</head>
<body style="margin: 0px">
<div id="container" style="position:absolute; width: 100%; height: 100%;"></div>

<!-- OR ANY OTHER AMD LOADER HERE INSTEAD OF loader.js -->

<script>var require = {paths: {'vs': '/assets/min/vs'}};</script>
<script src="/assets/min/vs/loader.js"></script>
<script src="/assets/min/vs/editor/editor.main.nls.js"></script>
<script src="/assets/min/vs/editor/editor.main.js"></script>
<script src="/js/monaco-collab-ext.js"></script>

<script>
	let name = prompt("Please enter your name", "");

	if (name == null || name == "") {
		name = "User 1";
	}

	const port 		= window.location.port
	const hostname 	= window.location.hostname
	var messageId
	var changes

	const getCursorColor = () => {
		return "#" + Math.floor(Math.random()*16777215).toString(16);
	}

	const generateUniqueId = () => {
		const timestamp = Date.now()
		const random 	= Math.floor(Math.random() * 1000000)
		const uniqueId 	= timestamp * 1000000 + random
		messageId 		= uniqueId

		return uniqueId
	}

	const thisCursor = {
		id: "Cursor" + generateUniqueId(),
		label: name,
		color: getCursorColor(),
		position: {lineNumber: 0, column: 0}
	}

	const sendChangeCodeMessage = (editor,  webSocket) => {
		let message =  {
			"type": "FmlEditorRequest",
			"id": generateUniqueId(),
			"code": editor.getModel().getValue(),
		}

		webSocket.send(JSON.stringify(message))
	}

	const sendChangeCursorMessage = (webSocket, cursor, position, init) => {
		let message =  {
			"type": "FmlEditorCursorChangeRequest",
			"id": generateUniqueId(),
			"label": cursor.label,
			"position": position,
			"color": cursor.color,
			"init": init,
		}
		webSocket.send(JSON.stringify(message))
	}

	const updateCursor = (editor, cursor) => {
		const offset = editor.getModel().getOffsetAt(editor.getPosition())
		cursor.setOffset(offset)
	}

	const clearCursors = (cursorManager) => {
		Array.from(cursorManager.getCursors()).map(cursor => {
			cursorManager.removeCursor(cursor.getCursorId())
		})
	}

	require.config({ paths: { vs: '/assets/min/vs' } })

	require(['vs/editor/editor.main', 'MonacoCollabExt'], function(m, MonacoCollabExt) {
		const editor = monaco.editor.create(document.getElementById('container'), {
			value: ['function x() {', '\tconsole.log("Hello world!");', '}'].join('\n'),
			language: 'javascript',
			theme: 'vs-dark'
		})

		console.log("init cursor : " + thisCursor.id)

		const remoteCursorManager = new MonacoCollabExt.RemoteCursorManager({
			editor: editor,
			tooltips: true,
			tooltipDuration: 2
		})

		const remoteCursor	= remoteCursorManager.addCursor(thisCursor.id, thisCursor.color, thisCursor.label)
		const webSocket		= new WebSocket(`ws://${hostname}:${port}/websocket`)

		webSocket.onopen = () => {
			sendChangeCursorMessage(webSocket, thisCursor, editor.getPosition(), true)
			updateCursor(editor, remoteCursor)
		}

		webSocket.onmessage = function (event) {
			let response = JSON.parse(event.data)

			if (response.type == "code") {
				editor.setValue(response.content)
			} else if (response.type == "cursor") {
				clearCursors(remoteCursorManager)

				let cursors = response.content
				cursors.forEach((cursor) => {
					let offset 	= editor.getModel().getOffsetAt(cursor.position)
					let newCursor = remoteCursorManager.addCursor(cursor.id, cursor.color, cursor.label)

					newCursor.setOffset(offset)
				})
			}
		}

		editor.onDidChangeCursorPosition((e) => {
			if(e.reason != 1){
				const offset = editor.getModel().getOffsetAt(editor.getPosition())

				remoteCursor.setOffset(offset)
				sendChangeCursorMessage(webSocket, thisCursor, editor.getPosition(), false)
			}
		})

		editor.onDidFocusEditorText((e) => {
			const offset = editor.getModel().getOffsetAt(editor.getPosition())

			remoteCursor.setOffset(offset)
			sendChangeCursorMessage(webSocket, thisCursor, editor.getPosition(), false)
		})

		editor.onKeyUp((e) => {
			if (e.keyCode != 37 && e.keyCode != 38 && e.keyCode != 39 && e.keyCode != 40 && e.keyCode != 15 && e.keyCode != 16 && e.keyCode != 17 && e.keyCode != 18){
				sendChangeCodeMessage(editor, webSocket)

				sendChangeCursorMessage(webSocket, thisCursor, editor.getPosition(), false)
			}
		})

		editor.onDidPaste(() => {
			sendChangeCodeMessage(editor, webSocket)
		})

		editor.onDidChangeModel(() => {
			console.log("code changed")
		})
	})

</script>
</body>
</html>



