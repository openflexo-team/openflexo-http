<!DOCTYPE html>
<html>
<head>
    <title>Openflexo Colab</title>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <link rel="stylesheet" href="/css/monaco-collab-ext.css">
    <link rel="stylesheet" href="/css/example.css">
</head>
<body style="margin: 0px">
<div id="container" style="position:absolute; width: 100%; height: 100%;"></div>

<!-- OR ANY OTHER AMD LOADER HERE INSTEAD OF loader.js -->

<script>var require = {paths: {'vs': '/monaco-editor/min/vs'}};</script>
<script src="/monaco-editor/min/vs/loader.js"></script>
<script src="/monaco-editor/min/vs/editor/editor.main.nls.js"></script>
<script src="/monaco-editor/min/vs/editor/editor.main.js"></script>
<script src="/js/monaco-collab-ext.js"></script>

<script>
    const port 		= window.location.port
    const hostname 	= window.location.hostname
    var messageId
    var changes

    var colors = ['red', 'blue', 'green', 'pink', 'yellow']

    const generateUniqueId = () => {
        const timestamp = Date.now()
        const random 	= Math.floor(Math.random() * 1000000)
        const uniqueId 	= timestamp * 1000000 + random
        messageId 		= uniqueId

        return uniqueId
    }

    const thisCursor = {
        id: "Cursor" + generateUniqueId(),
        label: "User 1",
        color: "orange",
        position: {lineNumber: 0, column: 0}
    }

    var cursors = [thisCursor]


    const sendMessage = (editor,  webSocket, change) => {
        let message =  {
            "type": "EditorText",
            "id": generateUniqueId(),
            "change": change,
            "code": editor.getModel().getValue(),
            "cursors": cursors
        }

        webSocket.send(JSON.stringify(message))
    }

    const updateCursor = (editor, cursor) => {
        const offset = editor.getModel().getOffsetAt(editor.getPosition())
        cursor.setOffset(offset)

        cursors.map((curs) => {
            if(curs.id == cursor.getCursorId()){
                curs.position = cursor.getPosition()
            }
            return curs
        })
    }

    require.config({ paths: { vs: '/monaco-editor/min/vs' } })

    require(['vs/editor/editor.main', 'MonacoCollabExt'], function(m, MonacoCollabExt) {
        const editor = monaco.editor.create(document.getElementById('container'), {
            value: ['function x() {', '\tconsole.log("Hello world!");', '}'].join('\n'),
            language: 'javascript',
            theme: 'vs-dark'
        })

        console.log("init cursor : " + thisCursor.id)

        const remoteCursorManager = new MonacoCollabExt.RemoteCursorManager({
            editor: editor,
            tooltips: true,
            tooltipDuration: 2
        })

        const remoteSelectionManager 	= new MonacoCollabExt.RemoteSelectionManager({editor: editor})

        let color = colors.pop()

        const thisCursorCursor 			= remoteCursorManager.addCursor(thisCursor.id, color, thisCursor.label)

        // remoteSelectionManager.addSelection(thisCursor.id, color, thisCursor.label)

        const webSocket 	= new WebSocket(`ws://${hostname}:${port}/websocket`)

        webSocket.onopen = () => {

            sendMessage(editor, webSocket, false)
        }

        webSocket.onmessage = function (event) {
            // let changes = (event.data)
            // editor.setValue(changes)
            // if(messageId !== changes.id) {
            // 	// editor.executeEdits("editor", changes.changes)
            // 	editor.setValue(changes)
            // 	messageId 	= changes.id
            // }
            let changes = JSON.parse(event.data)

            if(changes.change){
                editor.setValue(changes.code)
            }

            // Array.from(remoteCursorManager.getCursors()).map((cursor) => {
            // 	if(cursor.getCursorId() == changes.cursors[0].id){
            // 		remoteCursorManager.removeCursor(cursor.getCursorId())
            // 	}
            //
            // 	// remoteSelectionManager.removeSelection(cursor.getCursorId())
            //
            // })

            changes.cursors.forEach((cursor) => {

                try {
                    let tempCursor = remoteCursorManager._getCursor(cursor.id)

                    tempCursor.setPosition(cursor.position)
                } catch (e) {
                    let newCursor = remoteCursorManager.addCursor(cursor.id, cursor.color, cursor.label)

                    let offset = editor.getModel().getOffsetAt(cursor.position)
                    newCursor.setOffset(offset)
                }


                // if (tempCursor !== undefined){
                //
                // } else {
                //
                // }

            })
        }



        editor.onDidChangeCursorPosition((e) => {
            if(e.reason != 1){
                updateCursor(editor, thisCursorCursor)
                sendMessage(editor, webSocket, false)
            }

        })

        // editor.onDidFocusEditorText((e) => {
        // 	console.log("focused ")
        // })
        //
        // editor.onDidBlurEditorWidget((e) => {
        // 	console.log("focused 1")
        // })

        // editor.onDidChangeCursorSelection(e => {
        // 	const startOffset 	= editor.getModel().getOffsetAt(e.selection.getStartPosition())
        // 	const endOffset 	= editor.getModel().getOffsetAt(e.selection.getEndPosition())
        // 	remoteSelectionManager.setSelectionOffsets(thisCursor.id, startOffset, endOffset)
        // 	sendMessage(editor, webSocket, false)
        // })

        editor.onKeyUp((e) => {
            if (e.keyCode != 37 && e.keyCode != 38 && e.keyCode != 39 && e.keyCode != 40 && e.keyCode != 15 && e.keyCode != 16 && e.keyCode != 17 && e.keyCode != 18){


                // console.log(remoteCursorManager.getCursors())
                // console.log(cursors)
                cursors = []
                Array.from(remoteCursorManager.getCursors()).map((cursor) => {
                    let tempcurs = remoteCursorManager._getCursor(cursor.getCursorId())

                    cursors.push({
                        id: tempcurs.getCursorId(),
                        label: tempcurs.getLabel(),
                        color: tempcurs.getColor(),
                        position: tempcurs.getPosition().position
                    })
                })

                updateCursor(editor, thisCursorCursor)
                sendMessage(editor, webSocket, true)

                cursors.map(curs => {
                    let tempCursor = remoteCursorManager._getCursor(curs.id)
                    tempCursor.setPosition(curs.position)
                })


            }

        })



        editor.onDidPaste(() => {
            sendMessage(editor, webSocket, true)
        })

        // editor.onDidChangeCursorPosition(e => {
        // 	let offset = source.getModel().getOffsetAt(e.position)
        // 	thisCursorCursor.setOffset(offset)
        // })
        //
        // editor.onDidChangeCursorSelection(e => {
        // 	let startOffset	= source.getModel().getOffsetAt(e.selection.getStartPosition())
        // 	let endOffset 	= source.getModel().getOffsetAt(e.selection.getEndPosition())
        // 	remoteSelectionManager.setSelectionOffsets(thisCursor.id, startOffset, endOffset)
        // })

        // editor.getModel().onDidChangeContent((event) => {
        // 	// changes.push(...(event.changes))
        // 	changes = event.changes
        // 	editor.getId()
        // })
    })

</script>
</body>
</html>



